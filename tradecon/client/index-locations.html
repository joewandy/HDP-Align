
<!DOCTYPE html>
<meta charset="utf-8">
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no"/>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
    <script src="http://d3js.org/d3.v3.js"></script> 
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>

<style>

      text.mono {
        font-size: 10pt;
        font-family: Consolas, courier;
        fill: #aaa;
      }
      text.highlight {
        fill: #F00;
      }

      #map{
        width:800px;
        height:400px;
      }          

      .stations, .stations svg {
        position: absolute;
      }
      
      .stations svg {
        width: 60px;
        height: 20px;
        padding-right: 100px;
        font: 10px sans-serif;
      }
    </style>
  </head>


  <body>
    <script>
    function sendRequest()
    {
      $('#console').text("Send Request");
      $.ajax({
        dataType: "json",
        url: "http://138.251.207.183/test.php",
        data: $("#commoditiesQueryTextField").text(),
        success: function(data, httpCode, something){ updateData(data);},
        error: function(data){ $('#console').text("Request Error");} 
      });
      // $.get("http://138.251.207.183/test.php", function(data) {
      //   // alert("Data Loaded: " + data);
      //   updateData(data);
      // });
    }

    function colsToLocations(){

    }
    function colsToDisasters(){

    }
    function colsToDiseases(){

    }
    function colsToCommodities(){

    }



    </script>

    <div id="requestForm">
      <form>
       Commodities: <input id="commoditiesQueryTextField" type="text" name="commodities"/></br>
       Time Min: <input id="timeMinQueryTextField" type="text" name="timeMin"/></br>
       Time Max: <input id="timeMaxQueryTextField" type="text" name="timeMax"/></br>
      <button type="button" onclick="sendRequest()">Click Me!</button>    
    </form></div> 


    <label id="console"/>all fine!</label>

    <div id="map"></div>

    <div id="colAxisChooser">
      <input type="radio" name="colAxis" value="Locations" onClick="colsToLocations()">Locations<br>
      <input type="radio" name="colAxis" value="Locations" onClick="colsToDisasters()">Disasters<br>
      <input type="radio" name="colAxis" value="Locations" onClick="colsToDiseases()">Diseases<br>
      <input type="radio" name="colAxis" value="Commodities" onClick="colsToCommodities()">Commodities
    </div>

    <div id="chart">
      <button type="button" text="Change axis" onclick="changeAxis()"/>
    </div>

    <script type="text/javascript">
      
      var googlemap;
      // function createMap()
      // {
      //   // INIT MAP
        googlemap = new google.maps.Map(d3.select("#map").node(), {
            zoom: 2,
            center: new google.maps.LatLng(0,0),
            mapTypeId: google.maps.MapTypeId.TERRAIN
        }); 
        $('#console').text("Map Created");
      // }
      // google.maps.event.addDomListener(window, 'load', createMap);

      // INIT MATRIX
      var margin = { top: 50, right: 0, bottom: 100, left: 30 },
          width = 960 - margin.left - margin.right,
          height = 430 - margin.top - margin.bottom,
          gridSize = 10;
          legendElementWidth = gridSize*2,
          buckets = 9,
          colors = ["#ffffd9","#edf8b1","#c7e9b4","#7fcdbb","#41b6c4","#1d91c0","#225ea8","#253494","#081d58"], // alternatively colorbrewer.YlGnBu[9]
          x_zero = 120,
          y_zero = 60;
      var svg_mat;


      // PARSE DATA AND INIT VISUALIZATION
      d3.json("data/trades_2.json", function(error, data) 
      {
        //////////////////////////
        //// MAP with data
        //////////////////////////

        var overlay = new google.maps.OverlayView();
 
        // Add the container when the overlay is added to the map.
        overlay.onAdd = function() {
          var layer = d3.select(this.getPanes().overlayLayer).append("div")
              .attr("class", "stations");
  
            // Draw each marker as a separate SVG element.
            // We could use a single SVG, but what size would it have?
            overlay.draw = function() 
            {
              var projection = this.getProjection(), 
                padding = 10;
           
                var marker = layer.selectAll("svg")
                    .data(data)
                    .each(transform) // update existing markers
                    .enter().append("svg:svg")
                    .each(transform)
                    .attr("class", "marker");
           
                // Add a circle.
                marker.append("svg:circle")
                    .attr("r", 4.5)
                    .attr("opacity", 0.5)
                    .attr("cx", padding)
                    .attr("cy", padding);
           
                function transform(d) 
                {
                  var d = new google.maps.LatLng(d.location_lat, d.location_lon);
                  d = projection.fromLatLngToDivPixel(d);
                  return d3.select(this)
                      .style("left", (d.x - padding) + "px")
                      .style("top", (d.y - padding) + "px");
                };
              }
          }      
          overlay.setMap(googlemap);





        /////////////////////
        //// MATRIX with data
        /////////////////////

        var colorScale = d3.scale.quantile()
              .domain([1880,1890])
              .range(colors);


        var columns = new Array();
        var colCount = 0;
        var rows = new Array();
        var rowCount = 0;
        for (var i = 0, len = data.length; i < len; i++) {
            if(columns.indexOf(data[i].location_text) == -1){
              columns[colCount] = data[i].location_text;
              colCount++;
            }
            if(rows.indexOf(data[i].commodity_text) == -1){
              rows[rowCount] = data[i].commodity_text;
              rowCount++;
            }
        }
		
		//columns.sort()
		//rows.sort
		
		
		/*var locLat = new Array[][]
		var locLon = new Array[][]
		var locIndex = new Array[][]
		
		var mapLat  = d3.map(data, function(d,i) {			
			for (var i = 0, len = data.length; i < len; i++)
			{	
				locLat[i][0] = map.get(data[i].location_text)
				locLat[i][1] = map.get(data[i].location_lat)
								
			}
				 
		});
				
		var mapLon  = d3.map(data, function(d,i) {			
		for (var i = 0, len = data.length; i < len; i++)
		{	
			locLon[i][0] = map.get(data[i].location_text)
			locLon[i][1] = map.get(data[i].location_lon)
							
		}
				 
		});
		
		locLat.sort(function(a, b) {
			var avalue = a[1],
				bvalue = b[1];
			if (avalue < bvalue) {
				return -1;
			}
			if (avalue > bvalue) {
				return 1;
			}
			return 0;
		});*/
		
	
		
       
        svg_mat = d3.select("#chart").append("svg")
              .attr("width", width + margin.left + margin.right)
              .attr("height", height + margin.top + margin.bottom)
              .append("g")
              .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        var rowLabels = svg_mat.selectAll(".rowLabel")
              .data(rows)
              .enter().append("text")
                .text(function (d,i) { return data[i].commodity_text; })
                .attr("x", 0)
                .attr("y", function (d, i) { return (rows.indexOf(data[i].commodity_text) * gridSize) + y_zero; })
                .style("text-anchor", "end")
                .attr("transform", "translate(100,0)")
                .on("mouseover", mouseOverLabel)
                .on("mouseout", mouseOutLabel)
                .attr("class", "mono")
   
        var colLabels = svg_mat.selectAll(".columnLabel")
              .data(columns)
              .enter().append("text")
                .attr("id", function(d,i){ return data[i].location_text})
                .text(function(d,i) { return data[i].location_text; })
                .attr("y", function(d, i) { return columns.indexOf(data[i].location_text) * gridSize + x_zero; })
                .attr("x", -y_zero + 10)
                .style("text-anchor", "right")
                .attr("transform", "rotate(-90)")
                .on("mouseover", mouseOverLabel)
                .on("mouseout", mouseOutLabel)
                .attr("class", "mono columnLabel")
                .call(d3.behavior.drag().on("drag", moveColLabel))


        var cells = svg_mat.selectAll(".cell")
              .data(data)
              .enter().append("rect")
                .attr("y", function(d,i) { 
                   return y_zero + (rows.indexOf(data[i].commodity_text)-1) * gridSize; })
                .attr("x", function(d,i) { 
                   return x_zero + (columns.indexOf(data[i].location_text)-1) * gridSize;
                })
                .attr("width", gridSize)
                .attr("height", gridSize)
                // .style("fill", function(d,i) { return colorScale(data[i].pub_year)})
                .style("fill", "#000000")
                .style("opacity",  0.01)
              ;

        });
      // END OF JSON PARSING

 
      function updateData(jsonData)
      {
        $('#console').text("Request Success");
        // d3.json(jsonData, function(error, data) 
        // {
        //     // update data
        // }
      }

      function showError(t)
      {
        $('#console').text("Request Error");
        // d3.json(jsonData, function(error, data) 
        // {
        //     // update data
        // }
      }

      var mouseOverLabel = function(){
        var label = d3.select(this);
        label.attr("class", "mono highlight columnLabel");

        d3.selectAll(".columnLabel")
          .attr("class", function(d,i){ return ((i > 60) ? "mono highlight columnLabel" : "mono columnLabel");})

      }
      var mouseOutLabel = function(){
        d3.selectAll(".columnLabel")
          .attr("class", "mono columnLabel")
      }

      function moveColLabel(){
        var dragTarget = d3.select(this);
        dragTarget
          .attr("y", function(){return d3.event.dx + parseInt(dragTarget.attr("y"))});

        svg_mat.selectAll(".columnLabel")
          .attr("x", function(d,i){return 100});
      }

    </script>
  </body>
</html>