#LyX 2.0 created this file. For more info see http://www.lyx.org/
\lyxformat 413
\begin_document
\begin_header
\textclass scrartcl
\use_default_options true
\maintain_unincluded_children false
\language english
\language_package default
\inputencoding auto
\fontencoding global
\font_roman default
\font_sans default
\font_typewriter default
\font_default_family default
\use_non_tex_fonts false
\font_sc false
\font_osf false
\font_sf_scale 100
\font_tt_scale 100

\graphics default
\default_output_format default
\output_sync 0
\bibtex_command default
\index_command default
\paperfontsize default
\spacing single
\use_hyperref false
\papersize default
\use_geometry false
\use_amsmath 1
\use_esint 1
\use_mhchem 1
\use_mathdots 1
\cite_engine basic
\use_bibtopic false
\use_indices false
\paperorientation portrait
\suppress_date false
\use_refstyle 1
\index Index
\shortcut idx
\color #008000
\end_index
\secnumdepth 3
\tocdepth 3
\paragraph_separation skip
\defskip medskip
\quotes_language english
\papercolumns 1
\papersides 1
\paperpagestyle default
\tracking_changes false
\output_changes false
\html_math_output 0
\html_css_as_file 0
\html_be_strict false
\end_header

\begin_body

\begin_layout Title
HDP for Alignment of Multiple LC-MS Data in Metabolomics
\end_layout

\begin_layout Section
Introduction
\end_layout

\begin_layout Standard
Peak alignment is an important step in the pre-processing stages of LC-MS
 data.
 Errors produced during alignment will have a potentially significant impact
 in the later analysis stage (e.g.
 when performing differential analysis on the abundance of metabolites of
 interests).
 Existing methods do not take into account the dependencies of related peaks
 during alignments.
 We do that here by proposing a hierarchical Bayesian model that assigns
 related peaks to metabolite within and across files.
 
\end_layout

\begin_layout Section
Hierarchical Dirichlet Process (HDP) Mixture Model
\end_layout

\begin_layout Standard

\emph on
Add description about mixture model, DP, HDP, Chinese Restaurant Franchise
 and the stick breaking stuff
\end_layout

\begin_layout Standard
See 
\begin_inset CommandInset citation
LatexCommand cite
key "Kim2004"

\end_inset

 too.
\end_layout

\begin_layout Section
HDP Model - RT Only
\end_layout

\begin_layout Standard
Metabolites generates multiple clusters across files.
 In turn, clusters generates multiple peaks within files.
 We can model this process with a hierarchical mixture model of Gaussian
 components.
 Within each file, related peaks are grouped together.
 These groups are shared across files through top-level latent variables
 that represents the metabolites.
 We use Dirichlet Process (DP) prior to avoid setting the number of clusters
 a priori.
 The overall model fits into the Hierarchical Dirichlet Process (HDP) framework
 
\begin_inset CommandInset citation
LatexCommand cite
key "Teh2005"

\end_inset

.
\end_layout

\begin_layout Standard
The observed data is the peak RT values 
\begin_inset Formula $\mathbf{d}=(x_{n}^{j})$
\end_inset

 for all peaks across files.
 Within each file 
\begin_inset Formula $j$
\end_inset

, the peak RT value 
\begin_inset Formula $x_{n}^{j}$
\end_inset

 is drawn from its parent cluster's RT 
\begin_inset Formula $t_{k}^{j}$
\end_inset

, which is normally distributed.
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
x_{n}^{j}|t_{k}^{j},\gamma\sim\mathcal{N}(t_{k}^{j},\gamma^{-1})\label{eq:peakdist}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
The cluster RT 
\begin_inset Formula $t_{ij}$
\end_inset

 in file 
\begin_inset Formula $j$
\end_inset

 is drawn from the metabolite RT 
\begin_inset Formula $t_{i}$
\end_inset

 that is shared across all files.
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
t_{k}^{j}|t_{i},\delta\sim\mathcal{N}(t_{i},\delta^{-1})\label{eq:draw_tik}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
The metabolite RT 
\begin_inset Formula $t_{i}$
\end_inset

 is drawn from a base distribution of predicted retention times of metabolites.
 This is a Gaussian for now.
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
t_{i}|\mu_{0},\sigma_{0}\sim\mathcal{N}(\mu_{0},\sigma_{0}^{-1})\label{eq:draw_ti}
\end{equation}

\end_inset


\end_layout

\begin_layout Subsection
Modelling Assumptions
\end_layout

\begin_layout Standard
Some current assumptions to think about in the model:
\end_layout

\begin_layout Enumerate
Every peak must be generated by a metabolite.
 How about signals that are just noise (not coming from any metabolite)
 ?
\end_layout

\begin_layout Enumerate
Top-level component (metabolites) can produce multiple clusters in the same
 file.
 This seems to be a reasonable assumption ?
\end_layout

\begin_layout Enumerate
Not considering the mass information yet (including adducts, isotope etc)
 ..
\end_layout

\begin_layout Enumerate
We model RT drifts across replicates using the clusters (which are basically
 the noisy realisation of metabolite in each file).
 Assume clusters are IID given the parent metabolite, i.e.
 no correlation in the drift over time.
\end_layout

\begin_layout Subsection
\begin_inset CommandInset label
LatexCommand label
name "sub:Inference"

\end_inset

Inference
\end_layout

\begin_layout Standard
Denote the assignment of peak 
\begin_inset Formula $n$
\end_inset

 to cluster 
\begin_inset Formula $k$
\end_inset

 in file 
\begin_inset Formula $j$
\end_inset

 by 
\begin_inset Formula $z_{jnk}=1$
\end_inset

.
 The matrix 
\begin_inset Formula $\boldsymbol{Z}$
\end_inset

 contains this assignment for all indices 
\begin_inset Formula $j$
\end_inset

,
\begin_inset Formula $k$
\end_inset

 and 
\begin_inset Formula $n$
\end_inset

 in the model.
 We also need another indicator value to set the assignment of clusters
 within each file to the top-level component (metabolite) shared across
 files.
 Denote by 
\begin_inset Formula $v_{jki}=1$
\end_inset

 if cluster 
\begin_inset Formula $k$
\end_inset

 in file 
\begin_inset Formula $j$
\end_inset

 is assigned to metabolite 
\begin_inset Formula $i$
\end_inset

.
 Collectively, we store the assignments in the matrix 
\begin_inset Formula $\boldsymbol{V}$
\end_inset

 for all 
\begin_inset Formula $i$
\end_inset

, 
\begin_inset Formula $j$
\end_inset

 and 
\begin_inset Formula $k$
\end_inset

.
\end_layout

\begin_layout Standard
Given the observed data 
\begin_inset Formula $\mathbf{x}$
\end_inset

, our task is the infer the parameters 
\begin_inset Formula $\boldsymbol{\theta}=(\boldsymbol{t},\boldsymbol{t}^{j},\boldsymbol{Z},\boldsymbol{V})$
\end_inset

.
 We use Gibbs sampling to sample from the posterior distribution 
\begin_inset Formula $P(\boldsymbol{\theta}|\boldsymbol{x})\propto P(\boldsymbol{\boldsymbol{x}}|\boldsymbol{\theta})P(\boldsymbol{\theta})$
\end_inset

.
 The likelihood term 
\begin_inset Formula $P(\boldsymbol{\boldsymbol{x}}|\boldsymbol{\theta})$
\end_inset

 is
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
P(\boldsymbol{\boldsymbol{x}}|\boldsymbol{\theta})=\sum_{i}\sum_{j}\sum_{n}\left[p(x_{n}^{j}|t_{k}^{j})\cdot p(t_{k}^{j}|t_{i})\cdot p(z_{jnk}=1)\cdot p(v_{jki}=1)\right]
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
We set a DP prior with concentration parameter 
\begin_inset Formula $\alpha$
\end_inset

 on the assignment of peaks to clusters 
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\uuline off
\uwave off
\noun off
\color none

\begin_inset Formula $p(z_{jnk}=1)$
\end_inset

, and another DP prior with concentration parameter 
\begin_inset Formula $\alpha'$
\end_inset

 on the assignment of clusters to metabolites 
\begin_inset Formula $p(v_{jki}=1)$
\end_inset

.
 
\family default
\series default
\shape default
\size default
\emph default
\bar default
\strikeout default
\uuline default
\uwave default
\noun default
\color inherit
We use MCMC method to sample from the posterior distribution 
\begin_inset Formula $P(\boldsymbol{\theta}|\boldsymbol{x})$
\end_inset

.
 Specifically, we follow the posterior sampling in the Chinese restaurant
 franchise, as described in section 5.1 in 
\begin_inset CommandInset citation
LatexCommand cite
key "Teh2005"

\end_inset

.
 Here, we explicitly assign the peaks to their parent clusters, which are
 then assigned to the parent metabolites.
 
\end_layout

\begin_layout Standard
The next sub-sections describe the update steps during Gibbs sampling of
 the posterior distribution
\end_layout

\begin_layout Subsubsection
Initialisation
\end_layout

\begin_layout Enumerate
For every file, assign all peaks under 1 cluster.
 
\end_layout

\begin_layout Enumerate
Across files, all clusters are assigned under 1 global metabolite.
 
\end_layout

\begin_layout Enumerate
The metabolite's RT is sampled from the base distribution (eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:draw_ti"

\end_inset

), and the cluster's RT is sampled conditioned on it's parent metabolite
 RT (eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:draw_tik"

\end_inset

).
\end_layout

\begin_layout Subsubsection
Useful identities
\end_layout

\begin_layout Standard
The integral of the product of two pdf 
\begin_inset Formula $p(x|y,c)\cdot p(y|a,b)$
\end_inset

 where both are normal densities
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{eqnarray}
\int\left[\mathcal{N}(x|y,c^{-1})\cdot\mathcal{N}(y|a,b^{-1})\right]\, dy & \propto & \mathcal{N}(x|a,(c^{-1}+b^{-1}))\label{eq:integral_product}
\end{eqnarray}

\end_inset


\end_layout

\begin_layout Standard

\emph on
Proof to follow ...
\end_layout

\begin_layout Subsubsection
Updating peak assignments
\end_layout

\begin_layout Standard
To update the assignment of peak 
\begin_inset Formula $n$
\end_inset

 to cluster 
\begin_inset Formula $k$
\end_inset

 in file 
\begin_inset Formula $j$
\end_inset

, we need the conditional probability of 
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\uuline off
\uwave off
\noun off
\color none

\begin_inset Formula $p(z_{jnk}=1)$
\end_inset


\family default
\series default
\shape default
\size default
\emph default
\bar default
\strikeout default
\uuline default
\uwave default
\noun default
\color inherit
 given other parameters.
 This is
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
p(z_{jnk}=1|\ldots)\propto\begin{cases}
\begin{array}{c}
c_{jk}\cdot L(x_{n}^{j}|z_{jnk}=1)\\
\alpha_{t}\cdot L(x_{n}^{j}|z_{jnk^{*}}=1)
\end{array}\end{cases}\label{eq:table_likelihood}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
For existing cluster 
\begin_inset Formula $k$
\end_inset

, the likelihood of the peak is proportional to 
\begin_inset Formula $c_{jk}$
\end_inset

, the number of peaks inside that cluster.
 
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
L(x_{n}^{j}|z_{jnk}=1)=\mathcal{N}(x_{n}^{j}|t_{k}^{j},\gamma^{-1})\label{eq:existing_table}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
For a new cluster 
\begin_inset Formula $k^{*}$
\end_inset

, this is proportional to 
\begin_inset Formula $\alpha_{t}$
\end_inset

.
 The likelihood then depends on whether the peak is assigned to an existing
 metabolite 
\begin_inset Formula $i$
\end_inset

 or a new metabolite 
\begin_inset Formula $i^{*}$
\end_inset

.
 
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
L(x_{n}^{j}|z_{jnk^{*}}=1)=\sum_{i}\left[\frac{c_{i}}{\alpha^{'}+\sum_{i}c_{i}}p(x_{i}^{j}|v_{jni}=1)\right]+\frac{\alpha'}{\alpha^{'}+\sum_{i}c_{i}}p(x_{i}^{j}|v_{jni^{*}}=1)\label{eq:9}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
Here 
\begin_inset Formula $\alpha'$
\end_inset

 is the concentration parameter for metabolite DP mixture.
 Let the indicator 
\begin_inset Formula $v_{jni}=1$
\end_inset

 denotes the assignment of peak 
\begin_inset Formula $n$
\end_inset

 in file 
\begin_inset Formula $j$
\end_inset

 to metabolite 
\begin_inset Formula $i$
\end_inset

.
 Then for existing metabolite 
\begin_inset Formula $i$
\end_inset

, 
\begin_inset Formula $p(x_{i}^{j}|v_{jk^{*}i}=1)$
\end_inset

, the likelihood of the peak under that metabolite, can be computed by marginali
sing over all possible values of clusters RT 
\begin_inset Formula $t_{k}^{j}$
\end_inset

.
 Note that we use the identity in equation 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:integral_product"

\end_inset

 to go from equation 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:11"

\end_inset

 to equation 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:12"

\end_inset

.
 
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{eqnarray}
p(x_{n}^{j}|v_{jni}=1) & \propto & \int\left[p(x_{n}^{j}|t_{k}^{j},\gamma)p(t_{k}^{j}|t_{i},\delta)\right]\, dt_{k}^{j}\label{eq:10}\\
 & \propto & \int\left[\mathcal{N}(x_{n}^{j}|t_{k}^{j},\gamma^{-1})\cdot\mathcal{N}(t_{k}^{j}|t_{i},\delta^{-1})\right]\, dt_{k}^{j}\label{eq:11}\\
 & \propto & \mathcal{N}(x_{n}^{j}|t_{i},(\gamma^{-1}+\delta^{-1}))\label{eq:12}
\end{eqnarray}

\end_inset


\end_layout

\begin_layout Standard
For new metabolite 
\begin_inset Formula $i^{*}$
\end_inset

, the likelihood is obtained by marginalising over all possible values of
 clusters RT 
\begin_inset Formula $t_{k}^{j}$
\end_inset

 and metabolite RT 
\begin_inset Formula $t_{i}$
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{eqnarray}
p(x_{n}^{j}|v_{jni^{*}}=1) & \propto & \int\int\left[p(x_{n}^{j}|t_{k}^{j},\gamma)p(t_{k}^{j}|t_{i},\delta)\right]\, dt_{k}^{j}\, dt_{i}\label{eq:13}\\
 & \propto & \int\int\left[\mathcal{N}(x_{n}^{j}|t_{k}^{j},\gamma^{-1})\cdot\mathcal{N}(t_{k}^{j}|t_{i},\delta^{-1})\cdot\mathcal{N}(t_{i}|\mu_{0},\sigma_{0}^{-1})\right]\, dt_{k}^{j}\, dt_{i}\\
 & \propto & \mathcal{N}(x_{n}^{j}|\mu_{0},(\sigma_{0}^{-1}+\gamma^{-1}+\delta^{-1}))
\end{eqnarray}

\end_inset


\end_layout

\begin_layout Standard
The above assignment steps can be illustrated using the Chinese Restaurant
 Franchise metaphor.
 Here, a peak is a customer, a file is a restaurant, a cluster is a table,
 and a metabolite is a dish.
 During the Gibbs sampling step, a new customer 
\begin_inset Formula $n+1$
\end_inset

 arrives in the restaurant.
 We then need to determine whether this new customer is to be seated on
 a new or existing table.
 For an existing table, the likelihood proportional to the number of people
 already sitting on that table (
\begin_inset Formula $c_{jk}$
\end_inset

) times the likelihood of the new customer belonging on the table (eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:existing_table"

\end_inset

).
 For a new table, the likelihood is proportional to the DP concentration
 parameter 
\begin_inset Formula $\alpha$
\end_inset

 times the likelihood of ordering any of the existing or new dishes (eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:9"

\end_inset

).
 When deciding which dish to order, we marginalise over all possible tables
 in eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:10"

\end_inset

 and eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:13"

\end_inset

 (so we don't have to care about which table is actually selected).
 
\end_layout

\begin_layout Standard
Having computed both likelihood values of the customer sitting on existing
 tables or a new table (eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:table_likelihood"

\end_inset

), we do a coin toss to decide which table 
\begin_inset Formula $k$
\end_inset

 is actually selected.
 At this point, we should have maintained a restaurant-level variable 
\begin_inset Formula $K,$
\end_inset

 which is the counter of all tables that exist in the restaurant.
 If 
\begin_inset Formula $k\leq K$
\end_inset

, we send the customer to sit on table 
\begin_inset Formula $k$
\end_inset

 and share the dish already ordered by his friends sitting on table 
\begin_inset Formula $k$
\end_inset

.
 Otherwise if 
\begin_inset Formula $k>K$
\end_inset

, we increment 
\begin_inset Formula $K$
\end_inset

 by 1, create a new table 
\begin_inset Formula $k+1$
\end_inset

 and offers the customer the menu of dishes to order.
 At this point, the new table 
\begin_inset Formula $k+1$
\end_inset

 is created but not assigned any retention time value (mixture parameter)
 yet.
 We will return to this later.
 
\end_layout

\begin_layout Standard
Since the customer is the first to sit on the table, he would order the
 dish to be shared on that table.
 We reuse the computation done for eq.
 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:9"

\end_inset

 to compute the likelihood of the new customer ordering existing dishes
 or new dish, and do a coin toss to select the dish 
\begin_inset Formula $i$
\end_inset

.
 If 
\begin_inset Formula $i\leq I$
\end_inset

, where 
\begin_inset Formula $I$
\end_inset

 is the global counter of all dishes that exist 
\emph on
across restaurants
\emph default
, we serve the customer the dish 
\begin_inset Formula $i$
\end_inset

.
 Otherwise, we get our chef to devise a new dish 
\begin_inset Formula $i+1$
\end_inset

 for him.
 The new dish 
\begin_inset Formula $i+1$
\end_inset

 can subsequently be ordered by any new customer that arrives in any of
 the restaurant in our franchise.
 The mixture parameter (retention time value) 
\begin_inset Formula $t_{i}$
\end_inset

 of the new dish 
\begin_inset Formula $i+1$
\end_inset

 can be computed given the data 
\begin_inset Formula $x_{n}^{j}$
\end_inset

 using Bayes' rule:
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{eqnarray}
p(t_{i}|x_{n}^{j}) & \propto & p(x_{n}^{j}|t_{i})p(t_{i})\\
 & \propto & \left[\int p(x_{n}^{j}|t_{k}^{j})p(t_{k}^{j}|t_{i})\, dt_{k}^{j}\right]\,\cdot\, p(t_{i})\\
 & \propto & \left[\int\mathcal{N}(x_{n}^{j}|t_{k}^{j},\gamma^{-1})\cdot\mathcal{N}(t_{k}^{j}|t_{i},\delta^{-1})\, dt_{k}^{j}\right]\,\cdot\,\mathcal{N}(t_{i}|\mu_{0},\sigma_{0}^{-1})\\
 & \propto & \mathcal{N}(x_{n}^{j}|t_{i},\gamma^{-1}+\delta^{-1})\,\cdot\,\mathcal{N}(t_{i}|\mu_{0},\sigma_{0}^{-1})
\end{eqnarray}

\end_inset


\end_layout

\begin_layout Standard
In the LHS of the equation above, 
\begin_inset Formula $p(t_{i}|x_{n}^{j})$
\end_inset

 is a Normal distribution.
 Let's say it is parameterised by 
\begin_inset Formula $\mathcal{N}(t_{i}|\mu_{i},\gamma_{i}^{-1})$
\end_inset

.
 
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{eqnarray}
\mathcal{N}(t_{i}|\mu_{i},\gamma_{i}^{-1}) & \propto & \mathcal{N}(x_{n}^{j}|t_{i},\gamma^{-1}+\delta^{-1})\,\cdot\,\mathcal{N}(t_{i}|\mu_{0},\sigma_{0}^{-1})\\
exp\left(\frac{-\gamma_{i}}{2}(t_{i}-\mu_{i})^{2}\right) & \propto & exp\left(\frac{-(\gamma^{-1}+\delta^{-1})^{-1}}{2}(x_{n}^{j}-t_{i})^{2}+\frac{-\sigma_{0}}{2}(t_{i}-\mu_{0})^{2}\right)
\end{eqnarray}

\end_inset


\end_layout

\begin_layout Standard
Collecting the quadratic term containing 
\begin_inset Formula $(t_{i})^{2}$
\end_inset

, we can solve for 
\begin_inset Formula $\gamma_{i}$
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{eqnarray}
\frac{-\gamma_{i}}{2}(t_{i})^{2} & = & \frac{(\gamma^{-1}+\delta^{-1})^{-1}}{2}(t_{i})^{2}+\frac{-\sigma_{0}}{2}(t_{i})^{2}\\
\gamma_{i} & = & (\gamma^{-1}+\delta^{-1})^{-1}+\sigma_{0}
\end{eqnarray}

\end_inset


\end_layout

\begin_layout Standard
Similarly, collecting the linear term containing 
\begin_inset Formula $t_{i}$
\end_inset

, we can solve for 
\begin_inset Formula $\mu_{i}$
\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{eqnarray}
\frac{-\gamma_{i}}{2}(2t_{i}\mu_{i}) & = & \frac{-(\gamma^{-1}+\delta^{-1})^{-1}}{2}(2x_{n}^{j}t_{i})+\frac{-\sigma_{0}}{2}(2t_{i}\mu_{0})\\
-\gamma_{i}\mu_{i} & = & -(\gamma^{-1}+\delta^{-1})^{-1}x_{n}^{j}-\sigma_{0}\mu_{0}\\
\mu_{i} & = & \frac{1}{\gamma_{i}}\left[(\gamma^{-1}+\delta^{-1})^{-1}x_{n}^{j}+\sigma_{0}\mu_{0}\right]
\end{eqnarray}

\end_inset


\end_layout

\begin_layout Standard
So, when creating a new dish 
\begin_inset Formula $t_{i}$
\end_inset

, we sample its value from a Normal distribution 
\begin_inset Formula $\mathcal{N}(t_{i}|\mu_{i},\gamma_{i}^{-1})$
\end_inset

 with mean 
\begin_inset Formula $\mu_{i}$
\end_inset

 and precision 
\begin_inset Formula $\gamma_{i}$
\end_inset

 given above.
 Similarly, we can sample from the posterior distribution of table value
 
\begin_inset Formula $t_{k}^{j}$
\end_inset

 given its parent 
\begin_inset Formula $t_{i}$
\end_inset

 and the data 
\begin_inset Formula $x_{n}^{j}$
\end_inset

:
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{eqnarray}
p(t_{k}^{j}|x_{n}^{j}) & \propto & p(x_{n}^{j}|t_{k}^{j},\gamma)p(t_{k}^{j}|t_{i},\delta)=\mathcal{N}(t_{k}^{j}|\mu_{k},\gamma_{k}^{-1})
\end{eqnarray}

\end_inset


\end_layout

\begin_layout Standard
where
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\gamma_{k}=\gamma+\delta
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\mu_{k}=\frac{1}{\gamma_{k}}\left[\gamma x_{n}^{j}+\delta t_{i}\right]
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
The specific steps to update 
\begin_inset Formula $p(z_{jnk}=1)$
\end_inset

 is given in algorithm 
\begin_inset CommandInset ref
LatexCommand ref
reference "alg:assign_peaks_RT"

\end_inset

.
\end_layout

\begin_layout Standard
\begin_inset Float algorithm
placement H
wide false
sideways false
status open

\begin_layout Plain Layout
\noindent
\align center
\begin_inset listings
lstparams "basicstyle={\scriptsize},tabsize=4"
inline false
status open

\begin_layout Plain Layout

I = 0, K = 0
\end_layout

\begin_layout Plain Layout

j = loop randomly over files
\end_layout

\begin_layout Plain Layout

	n = loop randomly over peaks
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

		remove peak n from model
\end_layout

\begin_layout Plain Layout

		if this results in empty cluster k
\end_layout

\begin_layout Plain Layout

			delete cluster k from model
\end_layout

\begin_layout Plain Layout

			if this results in empty metabolite i
\end_layout

\begin_layout Plain Layout

				delete metabolite i from model
\end_layout

\begin_layout Plain Layout

				I = I-1
\end_layout

\begin_layout Plain Layout

			end
\end_layout

\begin_layout Plain Layout

		end
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

		P1 = compute cjk * L(x_n|existing cluster, eq 7)
\end_layout

\begin_layout Plain Layout

		P2 = compute alpha * L(x_n|new cluster, eq 8)
\end_layout

\begin_layout Plain Layout

		new_k = pick_cluster(P1, P2)
\end_layout

\begin_layout Plain Layout

		if new_k > K
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

			K = K+1
\end_layout

\begin_layout Plain Layout

			P3 = compute ci * L(x_n|t_i, eq 11)
\end_layout

\begin_layout Plain Layout

			P4 = compute alpha' * L(x_n|t_i, eq 14)
\end_layout

\begin_layout Plain Layout

			new_i = pick_metabolite(P3, P4)
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

			if new_i > I
\end_layout

\begin_layout Plain Layout

				I = I+1
\end_layout

\begin_layout Plain Layout

				ti = sample new metabolite RT given peak n (eq.
 18)
\end_layout

\begin_layout Plain Layout

				set metabolite RT = t_i
\end_layout

\begin_layout Plain Layout

			end
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

			assign v_jki = 1 for cluster k in file j to metabolite i
\end_layout

\begin_layout Plain Layout

			t_jk = sample new cluster RT given t_i and peak n (eq.
 26)
\end_layout

\begin_layout Plain Layout

			set cluster RT = t_jk
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

		end
\end_layout

\begin_layout Plain Layout

		assign Z_jnk = 1 for peak n to cluster k in file j			
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

	end
\end_layout

\begin_layout Plain Layout

end
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "alg:assign_peaks_RT"

\end_inset

Updating peak assignments (assign_peaks.m)
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
Updating cluster assignments
\end_layout

\begin_layout Standard
Given some existing cluster 
\begin_inset Formula $k$
\end_inset

, we would like to assign this cluster (a whole block of peaks 
\begin_inset Formula $\{x_{n}^{j}\}$
\end_inset

 under 
\begin_inset Formula $k$
\end_inset

) into a new metabolite 
\begin_inset Formula $i$
\end_inset

.
 
\end_layout

\begin_layout Standard
The probability is proportional to 
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\uuline off
\uwave off
\noun off
\color none

\begin_inset Formula $c_{i}$
\end_inset

 for existing metabolite and 
\begin_inset Formula $\alpha'$
\end_inset

 for new metabolite.
 The likelihood term for existing table is
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
p(t_{k}^{j}|t_{i},\delta)=\mathcal{N}(t_{k}^{j}|t_{i},\delta^{-1})
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
For new table, it is
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{eqnarray}
p(t_{k}^{j}|t_{i^{*}},...) & \propto & \int\left[p(t_{k}^{j}|t_{i},\delta)\,\cdot\, p(t_{i}|\mu_{0},\sigma_{0})\right]\, dt_{i}\\
 & \propto & \mathcal{N}(t_{k}^{j}|\mu_{0},(\delta^{-1}+\sigma_{0}^{-1}))
\end{eqnarray}

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Float algorithm
placement H
wide false
sideways false
status open

\begin_layout Plain Layout
\noindent
\align center
\begin_inset listings
lstparams "basicstyle={\scriptsize},tabsize=4"
inline false
status open

\begin_layout Plain Layout

j = loop randomly over files
\end_layout

\begin_layout Plain Layout

	k = loop randomly over clusters
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

		remove cluster k from model
\end_layout

\begin_layout Plain Layout

		if this results in empty metabolite i
\end_layout

\begin_layout Plain Layout

			delete cluster k from model
\end_layout

\begin_layout Plain Layout

			if this results in empty metabolite i
\end_layout

\begin_layout Plain Layout

				delete metabolite i from model
\end_layout

\begin_layout Plain Layout

				I = I-1
\end_layout

\begin_layout Plain Layout

			end
\end_layout

\begin_layout Plain Layout

		end
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

		P1 = compute ci * L(t_jk|existing metabolite, eq 29)
\end_layout

\begin_layout Plain Layout

		P2 = compute alpha' * L(t_jk|new metabolite, eq 32)
\end_layout

\begin_layout Plain Layout

		new_i = pick_metabolite(P1, P2)
\end_layout

\begin_layout Plain Layout

		if new_i > I
\end_layout

\begin_layout Plain Layout

			I = I+1
\end_layout

\begin_layout Plain Layout

			ti = sample new metabolite RT given ? (eq.
 ?)
\end_layout

\begin_layout Plain Layout

			set metabolite RT = ti
\end_layout

\begin_layout Plain Layout

		end
\end_layout

\begin_layout Plain Layout

		assign v_jki = 1 for cluster k in file j to metabolite i
\end_layout

\begin_layout Plain Layout

\end_layout

\begin_layout Plain Layout

	end
\end_layout

\begin_layout Plain Layout

end
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "alg:assign_cluster_RT"

\end_inset

Updating peak assignments (assign_peaks.m)
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Subsubsection
Updating metabolite RTs
\end_layout

\begin_layout Standard
The conditional probability of metabolite RTs 
\begin_inset Formula $p(t_{i}|\ldots)$
\end_inset

 is given by the product of the prior probability on 
\begin_inset Formula $t_{i}$
\end_inset

 multiplied by the likelihood of the RT values of metabolite 
\begin_inset Formula $i$
\end_inset

's child clusters.
 
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\uuline off
\uwave off
\noun off
\color none

\begin_inset Formula $t_{v_{jki}=1}^{j}$
\end_inset

 denotes the retention time of cluster 
\begin_inset Formula $k$
\end_inset

 in file 
\begin_inset Formula $j$
\end_inset

 that is assigned to metabolite 
\begin_inset Formula $i$
\end_inset

.
 There is a total of 
\begin_inset Formula $J$
\end_inset

 files altogether.
 So, for every metabolite 
\begin_inset Formula $i$
\end_inset

, we update its RT:
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
p(t_{i}|\ldots)\propto p(t_{i}|\mu_{0},\sigma_{0}^{-1})\prod_{j}^{J}\prod_{k}^{K}p(t_{v_{jki}=1}^{j}|t_{i},\delta^{-1})=\mathcal{N}(\mu_{a},\gamma_{a}^{-1})
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
where 
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\mu_{a}=\frac{1}{\gamma_{a}}\left[\mu_{0}\sigma_{0}+\delta\sum_{j}\sum_{k}t_{v_{jki}=1}^{j}\right]
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\gamma_{a}=\sigma_{0}+c_{v_{jki=1}}\delta
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
c_{v_{jki}=1}=\sum_{j}\sum_{k}I(v_{jki}=1)
\end{equation}

\end_inset


\end_layout

\begin_layout Subsubsection
Updating cluster RTs
\end_layout

\begin_layout Standard
Similar to above, for every 
\begin_inset Formula $j$
\end_inset

 file, there is a total of 
\begin_inset Formula $N$
\end_inset

 peaks inside.
 
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\uuline off
\uwave off
\noun off
\color none

\begin_inset Formula $x_{z_{jnk}=1}^{j}$
\end_inset

 denotes the retention time of peak 
\begin_inset Formula $n$
\end_inset

 that is assigned to cluster 
\begin_inset Formula $k$
\end_inset

 in file 
\begin_inset Formula $j$
\end_inset

.
 So, for every cluster 
\begin_inset Formula $k$
\end_inset

 in file 
\begin_inset Formula $j$
\end_inset

, we update its RT:
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
p(t_{k}^{j}|\ldots)\propto p(t_{k}^{j}|t_{i},\delta^{-1})\prod_{n}^{N}p(x_{z_{jnk}=1}^{j}|t_{k}^{j},\gamma^{-1})=\mathcal{N}(\mu_{b},\gamma_{b}^{-1})
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
where
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\mu_{b}=\frac{1}{\gamma_{b}}\left[t_{i}\delta+\gamma\sum_{n}x_{z_{jnk}=1}^{j}\right]
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\gamma_{b}=\delta+c_{z_{jnk}=1}\gamma
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
c_{z_{jnk}=1}=\sum_{n}I(z_{jnk}=1)
\end{equation}

\end_inset


\end_layout

\begin_layout Subsection
Marginalising out the clusters
\end_layout

\begin_layout Standard
If we marginalise out 
\begin_inset Formula $t_{k}^{j}$
\end_inset

, the metabolite RT 
\begin_inset Formula $t_{i}$
\end_inset

 is known but the new cluster RT 
\begin_inset Formula $t_{k}^{j}$
\end_inset

 is unknown, so we can no longer assume conditional independence between
 the peaks.
 To compute the probability of this block of peaks under the new metabolite
 
\begin_inset Formula $i$
\end_inset

, we have to apply the chain rule:
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
p(x_{1}^{j},x_{2}^{j},\ldots,x_{n}^{j}|t_{i})=p(x_{1}^{j}|t_{i})\cdot p(x_{2}^{j}|t_{i},x_{1}^{j})\cdot p(x_{3}^{j}|t_{i},x_{1}^{j},x_{2}^{j})\ldots p(x_{n}^{j}|t_{i},x_{1}^{j},x_{2}^{j},\ldots,x_{n-1}^{j})
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
where
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{eqnarray}
p(x_{n}^{j}|t_{i},x_{1}^{j},x_{2}^{j},\ldots,x_{n-1}^{j}) & = & \int\left[p(x_{n}^{j}|t_{k}^{j})\cdot p(t_{k}^{j}|t_{i},x_{1}^{j},x_{2}^{j},\ldots,x_{n-1}^{j})\right]dt_{k}^{j}
\end{eqnarray}

\end_inset


\end_layout

\begin_layout Standard

\emph on
More to come ...
\end_layout

\begin_layout Subsection
Matching
\end_layout

\begin_layout Standard
Quick note.
\end_layout

\begin_layout Standard
Given the grouping (clustering) of peaks within the top components, we have
 to perform another additional step of actually matching the peak.
 We use the samples produced during the Gibbs sampling to compute the posterior
 'similarity' of peaks.
 Following is a procedure for a quick test using the HDP result for matching.
 Steps involved:
\end_layout

\begin_layout Enumerate
Cluster all peaks across files at once using HDP
\end_layout

\begin_deeper
\begin_layout Enumerate
HDP score = posterior 'similarity' of two peaks being assigned to the same
 metabolite
\end_layout

\end_deeper
\begin_layout Enumerate
Perform greedy matching
\end_layout

\begin_deeper
\begin_layout Enumerate
Distance = Mahalanobis(p1, p2), but using HDP posterior similarity score
 above for the time component.
\end_layout

\begin_layout Enumerate
Peaks outside mass tolerance will not be matched
\end_layout

\end_deeper
\begin_layout Standard
Parameters:
\end_layout

\begin_layout Enumerate
# samples = 200 (100 burn-in)
\end_layout

\begin_layout Enumerate
mu_0 = mean of RT values from input files
\end_layout

\begin_layout Enumerate
sigma_0 = 1/5000
\end_layout

\begin_layout Enumerate
top_alpha = 1
\end_layout

\begin_layout Enumerate
alpha = 1
\end_layout

\begin_layout Enumerate
delta_prec = 1/30
\end_layout

\begin_layout Enumerate
gamma_prec = 1/60
\end_layout

\begin_layout Standard
Test on the P1 data: 2 replicates per fraction.
 Fraction 080 has ~ 1200 peaks, and fraction 100 has ~750 peaks.
\end_layout

\begin_layout Standard
OOops ...
 forgot to restrict the matching so that we match only peaks within the
 same component !
\end_layout

\begin_layout Subsection
Results
\end_layout

\begin_layout Standard
Not that great ?
\end_layout

\begin_layout Standard
\begin_inset Float table
wide false
sideways false
status open

\begin_layout Plain Layout
\noindent
\align center
\begin_inset Tabular
<lyxtabular version="3" rows="3" columns="6">
<features tabularvalignment="middle">
<column alignment="center" valignment="top" width="0">
<column alignment="center" valignment="top" width="0">
<column alignment="center" valignment="top" width="0">
<column alignment="center" valignment="top" width="0">
<column alignment="center" valignment="top" width="0">
<column alignment="center" valignment="top" width="0">
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Fraction
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Join
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
OpenMS
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
SIMA
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
MW
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
HDP
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
080
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
0.944
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
0.882
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
0.944
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
0.944
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
0.917
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
100
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
0.950
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
0.920
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
0.950
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
0.950
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
0.940
\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption

\begin_layout Plain Layout
F1 scores
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Float figure
wide false
sideways false
status open

\begin_layout Plain Layout
\noindent
\align center
\begin_inset Graphics
	filename images/figure.png
	width 100text%

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption

\begin_layout Plain Layout
P1_100.
 Left is posterior distribution of the number of top components inferred,
 right is the distribution on the 'similarity' of peaks.
 Peak p1 is similar to p2 if they are placed together under the same top
 component in a sample.
\end_layout

\end_inset


\end_layout

\end_inset


\end_layout

\begin_layout Subsection
Discussion
\end_layout

\begin_layout Enumerate
Are the probabilities well-calibrated ? We want to plot some ROC curve.
 Say, for each matching, assign the posterior similarity as its score.
 Make a ROC curve out of this.
 What do we get ?
\end_layout

\begin_layout Enumerate
Is there any relationship between the cluster retention time 
\begin_inset Formula $t_{ij}$
\end_inset

 and the metabolite retention time 
\begin_inset Formula $t_{i}$
\end_inset

 within each file.
 For each posterior sample within each file, plot the 
\begin_inset Formula $t_{ij}$
\end_inset

 and 
\begin_inset Formula $t_{i}$
\end_inset

, what do you observe / expect to see ? 
\end_layout

\begin_layout Section
HDP Model - RT & Mass
\end_layout

\begin_layout Standard
Each metabolite 
\begin_inset Formula $m$
\end_inset

 has 
\begin_inset Formula $A_{m}$
\end_inset

 possible adducts / deducts, where adduct 
\begin_inset Formula $a$
\end_inset

 in metabolite 
\begin_inset Formula $m$
\end_inset

 has 
\begin_inset Formula $I_{am}$
\end_inset

 isotopic peaks.
 Adduct is a product of direct addition of of >= 2 distinct molecules that
 results in a single reaction product containing all the atoms of the component
 molecules.
 In LC-MS, the term adduct ion refers refers to the ions formed by adduction
 of an ionic species to the molecule.
 In positive ion analysis, the most common metal adduct ions are single-charged
 sodium (
\begin_inset Formula $[M+Na]^{+})$
\end_inset

 and potassium (
\begin_inset Formula $[M+K]^{+}$
\end_inset

) adducts.
 Adduct ions can be recognized from the mass spectrum by observing the differenc
e from the analyte molecule, e.g.
 the adduct ion composition 
\begin_inset Formula $[M+H]^{+}$
\end_inset

 has the observed m/z value 
\begin_inset Formula $M+1$
\end_inset

, where 
\begin_inset Formula $M$
\end_inset

 is the molecular mass of the analyte molecule (i.e.
 metabolite).
 Most naturally occuring elements in nature consist of isotopes.
 Isotopes are variants of a particular chemical element that have the same
 number of protons but differ in the number of neutrons (they have different
 atomic mass).
 
\end_layout

\begin_layout Standard

\emph on
Describe ESI ionisation here ..
\end_layout

\begin_layout Standard
There are two modelling approaches when we want to bring in the mass information
: one where we consider the sum formula of the metabolite and one where
 we don't.
 
\end_layout

\begin_layout Subsection
Modelling mass with knowledge of formulae
\end_layout

\begin_layout Standard
The approach in MetAssign requires us to have the formula of the metabolite
 to begin with (since we're computing the isotopic profile from the formula,
 see 
\begin_inset CommandInset citation
LatexCommand cite
key "Snider2007"

\end_inset

).
 This is because peaks are related by their isotopic distribution along
 the m/z dimension (in the mass spectrum).
 Given observed peaks, we can attempt to predict their possible formulae
 as such:
\end_layout

\begin_layout Enumerate
Remove mass of adduct from the observed mass.
 This gives us the neutral mass 
\begin_inset Formula $m$
\end_inset


\end_layout

\begin_layout Enumerate
Generate 
\begin_inset Formula $F$
\end_inset

 = {all formulae possible given the mass constraint of 
\begin_inset Formula $m+\epsilon$
\end_inset

, where 
\begin_inset Formula $\epsilon$
\end_inset

 is the MS instrument accuracy}.
\end_layout

\begin_layout Enumerate
Filter 
\begin_inset Formula $F$
\end_inset

 by various heuristics such as the 7 golden rule 
\begin_inset CommandInset citation
LatexCommand cite
key "Kind2007"

\end_inset

, element counts, ring double bond etc.
 This should reduce 
\begin_inset Formula $|F|$
\end_inset

 a lot from say, 50000 entries to 1000.
\end_layout

\begin_layout Enumerate
For every 
\begin_inset Formula $f\in F$
\end_inset

, we can assign it some isotopic pattern score, which is the goodness of
 fit between the predicted isotopic peaks (generated by 
\begin_inset Formula $f$
\end_inset

 versus the observed peaks).
 Predicted peaks can be efficiently generated according to 
\begin_inset CommandInset citation
LatexCommand cite
key "Snider2007"

\end_inset

.
 Methods that compute this score are for e.g.
 in MzMine2 
\begin_inset CommandInset citation
LatexCommand cite
key "Pluskal2012"

\end_inset

 and SIRIUS 
\begin_inset CommandInset citation
LatexCommand cite
key "Bocker2009"

\end_inset

.
 
\end_layout

\begin_layout Standard

\emph on
Then what ...
 ?
\end_layout

\begin_layout Subsection
Modelling mass without knowledge of formulae
\end_layout

\begin_layout Standard
Another way is if we do not explicitly model the formula.
 The observed data is now a vector of mass and retention time 
\begin_inset Formula $\mathbf{d}_{n}^{j}=(x_{n}^{j},y_{n}^{j})$
\end_inset

 where 
\begin_inset Formula $x_{n}^{j}$
\end_inset

 is the retention time value and 
\begin_inset Formula $y_{n}^{j}$
\end_inset

 is the mass value of peak 
\begin_inset Formula $n$
\end_inset

 in file 
\begin_inset Formula $j$
\end_inset

.
 We perform the assignment of 
\begin_inset Formula $\mathbf{d}_{n}^{j}$
\end_inset

 based on its retention time value to RT cluster 
\begin_inset Formula $k$
\end_inset

 and metabolite 
\begin_inset Formula $i$
\end_inset

 (as in section 
\begin_inset CommandInset ref
LatexCommand ref
reference "sub:Inference"

\end_inset

) and also based on the mass information to separate peaks further into
 mass clusters.
 To do this, each metabolite 
\begin_inset Formula $i$
\end_inset

 is linked to an infinite mixture model (using DP prior) where components
 in this mixture model correspond to groupings of peaks by their masses.
 The Normal distribution is used as the component in the linked DP mixture.
 Individual peaks are now assigned to an RT cluster (and its respective
 parent metabolite) and put into a mass cluster.
\end_layout

\begin_layout Standard

\emph on
[draw the plate diagram here]
\end_layout

\begin_layout Standard
Table 
\begin_inset CommandInset ref
LatexCommand ref
reference "tab:CRF-analogy-for"

\end_inset

 shows the correspondence between the actual biological entities and their
 correspondence in the CRF analogy.
 In the CRF story, a customer 
\begin_inset Formula $n$
\end_inset

 walks into the restaurant 
\begin_inset Formula $j$
\end_inset

 and is seated at table 
\begin_inset Formula $k$
\end_inset

.
 He is then served the dish 
\begin_inset Formula $i$
\end_inset

 which is shared across the restaurant franchise.
 Additionally, the dish now also comes in seasoned varieties (e.g.
 less salt, spicier).
 
\end_layout

\begin_layout Standard
\begin_inset Float table
placement H
wide false
sideways false
status open

\begin_layout Plain Layout
\noindent
\align center
\begin_inset Tabular
<lyxtabular version="3" rows="6" columns="3">
<features tabularvalignment="middle">
<column alignment="center" valignment="top" width="0">
<column alignment="center" valignment="top" width="0">
<column alignment="center" valignment="top" width="0">
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Indexing variable
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Biological entity
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
CRF entity
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $n$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Peak
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Customer
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $j$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
File (replicate)
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Restaurant
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $k$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
RT cluster
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Table
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $i$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Metabolite
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Dish
\end_layout

\end_inset
</cell>
</row>
<row>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
\begin_inset Formula $a$
\end_inset


\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Mass cluster
\end_layout

\end_inset
</cell>
<cell alignment="center" valignment="top" topline="true" bottomline="true" leftline="true" rightline="true" usebox="none">
\begin_inset Text

\begin_layout Plain Layout
Seasoned dish
\end_layout

\end_inset
</cell>
</row>
</lyxtabular>

\end_inset


\end_layout

\begin_layout Plain Layout
\begin_inset Caption

\begin_layout Plain Layout
\begin_inset CommandInset label
LatexCommand label
name "tab:CRF-analogy-for"

\end_inset

CRF analogy for the RT + mass HDP model
\end_layout

\end_inset


\end_layout

\begin_layout Plain Layout

\end_layout

\end_inset


\end_layout

\begin_layout Standard
Let the indicator 
\begin_inset Formula $v_{jnia}=1$
\end_inset

 denotes the assignment of peak 
\begin_inset Formula $n$
\end_inset

 in file 
\begin_inset Formula $j$
\end_inset

 to metabolite 
\begin_inset Formula $i$
\end_inset

 and the mass cluster 
\begin_inset Formula $a$
\end_inset

 within 
\begin_inset Formula $i$
\end_inset

.
 Then following equation 
\begin_inset CommandInset ref
LatexCommand ref
reference "eq:table_likelihood"

\end_inset

, the likelihood of peak data point 
\begin_inset Formula $\mathbf{d}_{n}^{j}$
\end_inset

 going into an existing cluster is proportional to 
\begin_inset Formula $c_{jk}$
\end_inset

, the number of peaks inside that cluster.
 
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{eqnarray}
L(\mathbf{d}_{n}^{j}|z_{jnk}=1) & = & p(x_{n}^{j}|z_{jnk}=1)p(y_{n}^{j}|v_{jnia}=1)
\end{eqnarray}

\end_inset


\end_layout

\begin_layout Standard
where the RT term is
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
p(x_{n}^{j}|z_{jnk}=1)=\mathcal{N}(x_{n}^{j}|t_{k}^{j},\gamma^{-1})\label{eq:existing_table-1}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
and the mass term is 
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
p(y_{n}^{j}|v_{jnia}=1)=\sum_{a}\left[\frac{c_{ia}}{\alpha_{m}^{'}+\sum_{a}c_{ia}}p(y_{n}^{j}|v_{jnia}=1)\right]+\frac{\alpha_{m}}{\alpha_{m}+\sum_{a}c_{ia}}p(y_{n}^{j}|v_{jnia^{*}}=1)\label{eq:9-1}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
Then
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
p(y_{n}^{j}|v_{jnia}=1)=\mathcal{N}(y_{n}^{j}|\theta_{ia},\rho^{-1})
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
where 
\begin_inset Formula $\theta_{ia}$
\end_inset

 is the mean of the component 
\begin_inset Formula $a$
\end_inset

, and 
\begin_inset Formula $\rho^{-1}$
\end_inset

 the precision, which should a priori be set to be a small value by the
 user (or maybe we can draw from some Gamma distribution ?).
 The component mean 
\begin_inset Formula $\theta_{ia}$
\end_inset

 is drawn from the base distribution
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
p(\theta_{ia}|\theta_{0},\rho_{0})=\mathcal{N}(\theta_{ia}|\psi_{0},\rho_{0}^{-1})
\end{equation}

\end_inset


\end_layout

\begin_layout Standard

\end_layout

\begin_layout Standard
Similar to how it's done for RT clustering previously, once a customer has
 been offered a dish 
\begin_inset Formula $i$
\end_inset

, we compute the likelihood for the customer to be assigned existing or
 new seasoned dishes.
 The seasoned dish 
\begin_inset Formula $a$
\end_inset

 is selected via a cointoss.
 For each dish 
\begin_inset Formula $i,$
\end_inset

 the variable 
\begin_inset Formula $A_{i}$
\end_inset

 maintains the number of seasoned dish variations that exist.
 If the new seasoned dish is required (
\begin_inset Formula $a>A_{i}$
\end_inset

), we create one and serves that the customer 
\begin_inset Formula $n$
\end_inset

.
 When creating a new seasoned dish, we need to set its mixture parameter
 
\begin_inset Formula $\theta_{ia}$
\end_inset

 
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{eqnarray}
p(\theta_{ia}|y_{n}^{j}) & \propto & p(y_{n}^{j}|\theta_{ia},\rho)p(\theta_{ia}|\psi_{0},\rho_{0})=\mathcal{N}(\theta_{ia}|\mu_{a},\sigma_{a}^{-1})
\end{eqnarray}

\end_inset


\end_layout

\begin_layout Standard
where
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\sigma_{a}=\rho+\rho_{0}
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\mu_{a}=\frac{1}{\sigma_{a}}\left[\rho y_{n}^{j}+\rho_{0}\psi_{0}\right]
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
Then 
\family roman
\series medium
\shape up
\size normal
\emph off
\bar no
\strikeout off
\uuline off
\uwave off
\noun off
\color none
for every mass cluster 
\begin_inset Formula $a$
\end_inset

 in the mixture associated to metabolite 
\begin_inset Formula $i$
\end_inset

, we update its mixture parameter:
\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
p(\theta_{ia}|\ldots)\propto p(\theta_{ia}|\psi_{0},\rho_{0})\prod_{n}^{N}p(y_{n}^{j}|\theta_{ia},\rho)=\mathcal{N}(\mu_{b},\sigma_{b}^{-1})
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\sigma_{b}=\rho_{0}+N\rho
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
\begin_inset Formula 
\begin{equation}
\mu_{b}=\frac{1}{\sigma_{b}}\left[\rho_{0}\psi_{0}+\rho\sum_{n}y_{n}^{j}\right]
\end{equation}

\end_inset


\end_layout

\begin_layout Standard
It is also possible for a customer or a set of customers to reject the seasoned
 dish served.
 This happens when a customer 
\begin_inset Formula $n$
\end_inset

 is switching table from 
\begin_inset Formula $k$
\end_inset

 to 
\begin_inset Formula $k'$
\end_inset

, or when the whole table 
\begin_inset Formula $k$
\end_inset

 switches the dish assigned to it from 
\begin_inset Formula $i$
\end_inset

 to 
\begin_inset Formula $i'$
\end_inset

.
 In this case, we have to perform the necessary book-keeping such as recomputing
 the mixture parameter 
\begin_inset Formula $\theta_{ia}$
\end_inset

 when its customer membership changes, and deleting the whole lot of dish
 variations 
\begin_inset Formula $a$
\end_inset

 when their linked dish 
\begin_inset Formula $i$
\end_inset

 is deleted.
\end_layout

\begin_layout Standard
\begin_inset CommandInset bibtex
LatexCommand bibtex
bibfiles "/home/joewandy/Project/documents/library"
options "plain"

\end_inset


\end_layout

\end_body
\end_document
